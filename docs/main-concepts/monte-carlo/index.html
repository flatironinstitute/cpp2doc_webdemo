<!DOCTYPE html>

<html lang="en-US">
  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>MC tools | TRIQS</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="MC tools" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="TRIQS (Toolbox for Research on Interacting Quantum Systems) is a set of C++ and Python libraries for the study of interacting quantum systems." />
<meta property="og:description" content="TRIQS (Toolbox for Research on Interacting Quantum Systems) is a set of C++ and Python libraries for the study of interacting quantum systems." />
<link rel="canonical" href="/main-concepts/monte-carlo/" />
<meta property="og:url" content="/main-concepts/monte-carlo/" />
<meta property="og:site_name" content="TRIQS" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/triqs-logo-v2-black.svg"}},"url":"/main-concepts/monte-carlo/","headline":"MC tools","description":"TRIQS (Toolbox for Research on Interacting Quantum Systems) is a set of C++ and Python libraries for the study of interacting quantum systems.","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

  
  <title>MC tools - TRIQS</title>

   

  <link
    rel="shortcut icon"
    href="/favicon.ico"
    type="image/x-icon"
  />

  <link
    rel="stylesheet"
    href="/assets/css/jek-theme-triqs.css"
  />

  

    <!-- Katex -->
    <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"
    integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq"
    crossorigin="anonymous"
  />
  <!-- The loading of KaTeX is deferred to speed up page rendering -->
  <script
    defer
    src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"
    integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz"
    crossorigin="anonymous"
  ></script>
  <!-- To automatically render math in text elements, include the auto-render extension: -->
  <script
    defer
    src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"
    integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI"
    crossorigin="anonymous"
    onload="renderMathInElement(document.body);"
  ></script>

  
  <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script>
  
  <script type="text/javascript" src="/assets/js/jek-theme-triqs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>MC tools | TRIQS</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="MC tools" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="TRIQS (Toolbox for Research on Interacting Quantum Systems) is a set of C++ and Python libraries for the study of interacting quantum systems." />
<meta property="og:description" content="TRIQS (Toolbox for Research on Interacting Quantum Systems) is a set of C++ and Python libraries for the study of interacting quantum systems." />
<link rel="canonical" href="/main-concepts/monte-carlo/" />
<meta property="og:url" content="/main-concepts/monte-carlo/" />
<meta property="og:site_name" content="TRIQS" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/triqs-logo-v2-black.svg"}},"url":"/main-concepts/monte-carlo/","headline":"MC tools","description":"TRIQS (Toolbox for Research on Interacting Quantum Systems) is a set of C++ and Python libraries for the study of interacting quantum systems.","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <meta name="viewport" content="width=device-width, initial-scale=1" />

</head>

<body>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="link" viewBox="0 0 16 16">
      <title>Link</title>
      <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </symbol>
  </svg>

  <div class="page-wrap">
    <div class="side-bar">
      <div class="site-header">
        <a href="" class="site-title lh-tight">
  <div class="site-logo"></div>

</a>
        <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button>
      </div>

      <div class="navigation main-nav js-main-nav">
        <nav role="navigation" aria-label="Main navigation">
  <ul class="navigation-list"><li class="navigation-list-item"><a href="/" class="navigation-list-link">Home</a></li><li class="navigation-list-item"><a href="/apps/" class="navigation-list-link">Applications</a></li><li class="navigation-list-item active"><a href="/main-concepts/" class="navigation-list-link">Main Concepts</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/main-concepts/fake-thing/" class="navigation-list-link">Fake Thing</a></li><li class="navigation-list-item "><a href="/main-concepts/greens-functions/" class="navigation-list-link">Green's Functions</a></li><li class="navigation-list-item  active"><a href="/main-concepts/monte-carlo/" class="navigation-list-link active">MC tools</a></li></ul></li><li class="navigation-list-item"><a href="/community/" class="navigation-list-link">Community</a></li><li class="navigation-list-item"><a href="/cpp-api/" class="navigation-list-link">Basic C++ Libraries</a><ul class="navigation-list-child-list "></ul></li><li class="navigation-list-item"><a href="/python-api/" class="navigation-list-link">Python API</a></li><li class="navigation-list-item"><a href="/triqs/" class="navigation-list-link">Triqs Core Library</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/triqs/gf/" class="navigation-list-link">triqs::gf</a></li><li class="navigation-list-item "><a href="/triqs/liz-thing/" class="navigation-list-link">triqs::liz-thing</a></li></ul></li><li class="navigation-list-item"><a href="/theme/" class="navigation-list-link">Theme</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="/theme/configuration/" class="navigation-list-link">Configuration</a></li><li class="navigation-list-item "><a href="/theme/navigation/" class="navigation-list-link">Navigation</a></li><li class="navigation-list-item "><a href="/theme/ui-components/" class="navigation-list-link">UI Components</a><ul class="navigation-list-child-list"><li class="navigation-list-item ">
                            <a href="/theme/ui-components/markdown/" class="navigation-list-link">Markdown</a>
                          </li><li class="navigation-list-item ">
                            <a href="/theme/ui-components/typography/" class="navigation-list-link">Typography</a>
                          </li><li class="navigation-list-item ">
                            <a href="/theme/ui-components/buttons/" class="navigation-list-link">Buttons</a>
                          </li><li class="navigation-list-item ">
                            <a href="/theme/ui-components/labels/" class="navigation-list-link">Labels</a>
                          </li><li class="navigation-list-item ">
                            <a href="/theme/ui-components/tables/" class="navigation-list-link">Tables</a>
                          </li><li class="navigation-list-item ">
                            <a href="/theme/ui-components/lists/" class="navigation-list-link">Lists</a>
                          </li><li class="navigation-list-item ">
                            <a href="/theme/ui-components/code/" class="navigation-list-link">Code</a>
                          </li></ul></li><li class="navigation-list-item "><a href="/theme/utilities/" class="navigation-list-link">Utilities</a><ul class="navigation-list-child-list"><li class="navigation-list-item ">
                            <a href="/theme/utilities/responsive/" class="navigation-list-link">Responsive Modifiers</a>
                          </li><li class="navigation-list-item ">
                            <a href="/theme/utilities/layout/" class="navigation-list-link">Layout</a>
                          </li><li class="navigation-list-item ">
                            <a href="/theme/utilities/color/" class="navigation-list-link">Color</a>
                          </li><li class="navigation-list-item ">
                            <a href="/theme/utilities/search/" class="navigation-list-link">Search</a>
                          </li><li class="navigation-list-item ">
                            <a href="/theme/utilities/typography/" class="navigation-list-link">Typography</a>
                          </li></ul></li></ul></li></ul>
</nav>
      </div>
      <footer class="site-footer">
        <p class="text-small text-grey-dk-000 mb-4">A project of the
          <a href="https://www.simonsfoundation.org/flatiron/center-for-computational-quantum-physics/software/development-of-the-triqs-software/">Center for Computational Quantum Physics</a>.</p>
          <p class="text-small text-grey-dk-000 mb-4">Version 0.0.3</p>
      </footer>
    </div>
    <div class="main-content-wrap js-main-content" tabindex="0">
      <div class="main-content">
        <div class="page-header js-page-header">
          
          <div class="search">
            <div class="search-input-wrap">
              <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search TRIQS" aria-label="Search TRIQS" autocomplete="off">
              <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg>
            </div>
            <div class="js-search-results search-results-wrap"></div>
          </div>
          
          
            <ul class="list-style-none text-small aux-nav">
              
                <li class="d-inline-block my-0"><a href="//github.com/TRIQS/triqs">TRIQS on GitHub</a></li>
              
            </ul>
          
        </div>
        <div class="page">
          
            
              <nav class="breadcrumb-nav">
                <ol class="breadcrumb-nav-list">
<li class="breadcrumb-nav-list-item"><a href="/main-concepts/">main-concepts</a></li>
                  
<li class="breadcrumb-nav-list-item"><a href="/main-concepts/monte-carlo/">monte-carlo</a></li>
                  
                </ol>
              </nav>
            
          
          <div id="main-content" class="page-content" role="main">
            
              <h1 class="no_toc" id="monte-carlo-tools">
        
        
          <a href="#monte-carlo-tools" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Monte Carlo Tools
        
        
      </h1>
    
      <h2 class="no_toc text-delta" id="table-of-contents">
        
        
          <a href="#table-of-contents" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Table of contents
        
        
      </h2>

<ol id="markdown-toc">
  <li><a href="#tutorial" id="markdown-toc-tutorial">Tutorial</a></li>
  <li><a href="#a-collapsible-section-with-markdown" id="markdown-toc-a-collapsible-section-with-markdown">A collapsible section with markdown</a>    <ol>
      <li><a href="#writing-someting" id="markdown-toc-writing-someting">writing someting</a></li>
      <li><a href="#the-c-code-for-this-problem" id="markdown-toc-the-c-code-for-this-problem">The C++ code for this problem</a></li>
      <li><a href="#initializing-the-mpi" id="markdown-toc-initializing-the-mpi">Initializing the MPI</a></li>
      <li><a href="#constructing-the-monte-carlo-simulation" id="markdown-toc-constructing-the-monte-carlo-simulation">Constructing the Monte Carlo simulation</a></li>
      <li><a href="#moves-and-measures" id="markdown-toc-moves-and-measures">Moves and measures</a></li>
      <li><a href="#the-move" id="markdown-toc-the-move">The move</a></li>
      <li><a href="#the-measure" id="markdown-toc-the-measure">The measure</a></li>
      <li><a href="#starting-the-monte-carlo-simulation" id="markdown-toc-starting-the-monte-carlo-simulation">Starting the Monte Carlo simulation</a></li>
      <li><a href="#end-of-the-simulation---gathering-results" id="markdown-toc-end-of-the-simulation---gathering-results">End of the simulation - gathering results</a></li>
      <li><a href="#writing-your-own-monte-carlo-simulation" id="markdown-toc-writing-your-own-monte-carlo-simulation">Writing your own Monte Carlo simulation</a></li>
    </ol>
  </li>
</ol>
    <hr />

<p>SOME TEXT is to be written here, but it is long</p>

<p>&lt;%
import numpy as np
import matplotlib.pyplot as plt</p>

<p>x1 = np.linspace(0.0, 5.0)
x2 = np.linspace(0.0, 2.0)</p>

<p>y1 = np.cos(0.5 * np.pi * x1) * np.exp(-x1)
y2 = np.cos(2 * np.pi * x2)</p>

<p>plt.subplot(2, 1, 1)
plt.plot(x1, y1, ‘o-‘)
plt.title(‘A tale of 2 subplots’)
plt.ylabel(‘Damped oscillation’)</p>

<p>plt.subplot(2, 1, 2)
plt.plot(x2, y2, ‘.-‘)
plt.xlabel(‘time (s)’)
plt.ylabel(‘Undamped’)
%&gt;</p>

<p>IMAGE IS presented ABOVE</p>

<p><code class="highlighter-rouge">c++
template&lt;typename T, int R&gt; struct A;
</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">,</span> <span class="kt">int</span> <span class="n">R</span><span class="p">&gt;</span> <span class="k">struct</span> <span class="nc">A</span><span class="p">;</span>
</code></pre></div></div>

<p>and in ~~python~~</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
  <span class="k">return</span> <span class="n">a</span>
</code></pre></div></div>

<p>Some text &lt;% inline stuff %&gt;</p>

<p>and a block</p>

<p>which ends hre</p>

<ul>
  <li>TOC</li>
</ul>
      <h1 id="tutorial">
        
        
          <a href="#tutorial" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Tutorial
        
        
      </h1>

<p><a href="/cpp">LINK</a></p>

<p><a href="/_pages/doc/nda/index">LINK</a></p>
    
      <h1 id="a-collapsible-section-with-markdown">
        
        
          <a href="#a-collapsible-section-with-markdown" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> A collapsible section with markdown
        
        
      </h1>
<details>
  <summary>Click to expand!</summary>

  ## Heading
  1. A numbered
  2. list
     * With some
     * Sub bullets
</details>

<p>I want to write<span style="color:red">in read</span></p>

<p height="36px" width="36px">And the <img src="https://www.google.com" alt="result" /></p>

<p>{::mytension}</p>
    
      <h2 id="writing-someting">
        
        
          <a href="#writing-someting" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> writing someting
        
        
      </h2>
<p>ee: 1
…
{:/mytension}</p>

<p>n order to have a first overview of the main features of the
<code class="highlighter-rouge">mc_generic</code> class, let’s start with a concrete Monte Carlo code. We
will consider maybe the simplest problem ever: a single spin in a
magnetic field (h) at a temperature (1/\beta). The Hamiltonian is
simply:</p>

<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">H</mi><mo>=</mo><mo>−</mo><mi>h</mi><mo stretchy="false">(</mo><msub><mi>n</mi><mo>↑</mo></msub><mo>−</mo><msub><mi>n</mi><mo>↓</mo></msub><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">\mathcal{H} = - h (n_\uparrow - n_\downarrow).</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.00965em;">H</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord">−</span><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mrel mtight">↑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mrel mtight">↓</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">.</span></span></span></span></span>

<p>You want to compute the magnetization of this single spin. From
statistical mechanics it is clearly just</p>

<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>β</mi><mi>h</mi><mo stretchy="false">)</mo><mo>−</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mo>−</mo><mi>β</mi><mi>h</mi><mo stretchy="false">)</mo></mrow><mrow><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>β</mi><mi>h</mi><mo stretchy="false">)</mo><mo>+</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mo>−</mo><mi>β</mi><mi>h</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">m = \frac{\exp(\beta h) - \exp(-\beta h)}{\exp(\beta h) + \exp(-\beta h)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mord mathdefault">h</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mord mathdefault">h</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mord mathdefault">h</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop">exp</span><span class="mopen">(</span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="mord mathdefault">h</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>
    
      <h2 id="the-c-code-for-this-problem">
        
        
          <a href="#the-c-code-for-this-problem" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> The C++ code for this problem
        
        
      </h2>

<p>Let’s see how we can get this result from a <em>Monte Carlo</em> simulation. Here
is a code that would do the job. Note that we put everything in one file
here, but obviously you would usually want to cut this into pieces for
clarity:</p>

<div class="literalinclude">

./overview\_ex.cpp

</div>

<p>Let’s go through the different parts of this code. First we look at
<code class="highlighter-rouge">main()</code>.</p>
    
      <h2 id="initializing-the-mpi">
        
        
          <a href="#initializing-the-mpi" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Initializing the MPI
        
        
      </h2>

<p>As you will see, the Monte Carlo class is completely MPI ready. The
first two lines of the <code class="highlighter-rouge">main()</code> just initialize the MPI environment and
declare a communicator. The default communicator is <code class="highlighter-rouge">WORLD</code> which means
that all the nodes will be involved in the calculation:</p>

<p><code class="highlighter-rouge">cpp
triqs::mpi::environment env(argc, argv);
triqs::mpi::communicator world;
</code></p>
    
      <h2 id="constructing-the-monte-carlo-simulation">
        
        
          <a href="#constructing-the-monte-carlo-simulation" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Constructing the Monte Carlo simulation
        
        
      </h2>

<p>The lines that follow, define the parameters of the Monte Carlo
simulation and construct a Monte Carlo object called <code class="highlighter-rouge">SpinMC</code>:</p>

<p>``` cpp
int n_cycles = 5000000;
int length_cycle = 10;
int n_warmup_cycles = 10000;
std::string random_name = “”;
int random_seed = 374982 + world.rank() * 273894;
int verbosity = (world.rank() == 0 ? 2: 0);</p>

<p>triqs::mc_tools::mc_generic<double> SpinMC(random_name, random_seed, initial_sign, verbosity);
```</double></p>

<p>The <code class="highlighter-rouge">SpinMC</code> is an instance of the <code class="highlighter-rouge">mc_generic</code> class. First of all,
note that you need to include the header
<code class="highlighter-rouge">&lt;triqs/mc_tools/mc_generic.hpp&gt;</code> in order to access the <code class="highlighter-rouge">mc_generic</code>
class. The <code class="highlighter-rouge">mc_generic</code> class is a template on the type of the Monte
Carlo sign. Usually this will be either a <code class="highlighter-rouge">double</code> or a
<code class="highlighter-rouge">complex&lt;double&gt;</code>.</p>

<p>The first two arguments define the random number generator by giving its
name in <code class="highlighter-rouge">random_name</code> (an empty string means the default generator, i.e.
the Mersenne Twister) and the random seed in <code class="highlighter-rouge">random_seed</code>. As you see
the seed is different for all node with the use of <code class="highlighter-rouge">world.rank()</code>.</p>

<p>The third argument is the sign of the very first <em>configuration</em> of the
simulation. Because the <code class="highlighter-rouge">accept</code> method only returns a ratio, this
initial sign is used to determine the sign of all generated
configurations.</p>

<p>Finally, the last parameter sets the verbosity level. 0 means no output,
1 will output the progress level for the current node and 2 additionally
shows some statistics about the simulation when you call
<code class="highlighter-rouge">collect_results</code>. As you see, we have put <code class="highlighter-rouge">verbosity</code> to 2 only for the
master node and 0 for all the other ones. This way the information will
be printed only by the master.</p>
    
      <h2 id="moves-and-measures">
        
        
          <a href="#moves-and-measures" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Moves and measures
        
        
      </h2>

<p>At this stage the basic structure of the Monte Carlo is in <code class="highlighter-rouge">SpinMC</code>. But
we now need to tell it what moves must be tried and what measures must
be made. This is done with:</p>

<div class="literalinclude" data-lines="76-77">

overview\_ex.cpp

</div>

<p>The method <code class="highlighter-rouge">add_move</code> expects a move and a name, while <code class="highlighter-rouge">add_measure</code>
expects a measure and a name. The name can be anything, but different
measures must have different names. In this example, the move is an
instance of the <code class="highlighter-rouge">flip</code> class and the measure an instance of the
<code class="highlighter-rouge">compute_m</code> class. These classes have been defined in the beginning of
the code and they have no direct connection with the <code class="highlighter-rouge">mc_generic</code> class
(e.g. they don’t have inheritance links with <code class="highlighter-rouge">mc_generic</code>). Actually you
are almost completely free to design these classes as you want, <strong>as
long as they satisfy the correct concept</strong>.</p>
    
      <h2 id="the-move">
        
        
          <a href="#the-move" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> The move
        
        
      </h2>

<p>Let’s go back to the beginning of the code and have a look at the <code class="highlighter-rouge">flip</code>
class which proposed a flip of the spin. The class is very short. It has
a constructor which might define some class variables. But more
importantly, it has three member functions that any move <strong>must</strong> have:
<code class="highlighter-rouge">attempt</code>, <code class="highlighter-rouge">accept</code> and <code class="highlighter-rouge">reject</code>:</p>

<div class="literalinclude" data-lines="14-25">

overview\_ex.cpp

</div>

<p>The <code class="highlighter-rouge">attempt</code> method is called by the Monte Carlo loop in order to try a
new move. The Monte Carlo class doesn’t care about what this trial is.
All that matters for the loop is the Metropolis ratio describing the
transition to a new proposed configuration. It is precisely this ratio
that the <code class="highlighter-rouge">attempt</code> method is expected to return:</p>

<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>=</mo><mfrac><mrow><msub><mi>P</mi><mrow><mi>y</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub><mi>ρ</mi><mo stretchy="false">(</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><mrow><msub><mi>P</mi><mrow><mi>x</mi><mo separator="true">,</mo><mi>y</mi></mrow></msub><mi>ρ</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">T = \frac{P_{y,x} \rho(y)}{P_{x,y}\rho(x)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.399108em;vertical-align:-0.972108em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord mathdefault">ρ</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord mathdefault">ρ</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.972108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span>

<p>In our example this ratio is</p>

<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>=</mo><mfrac><msup><mi>e</mi><mrow><mi>β</mi><mi>h</mi><mo>−</mo><mi>σ</mi></mrow></msup><msup><mi>e</mi><mrow><mi>β</mi><mi>h</mi><mi>σ</mi></mrow></msup></mfrac><mo>=</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn><mi>β</mi><mi>h</mi><mi>σ</mi></mrow></msup></mrow><annotation encoding="application/x-tex">T = \frac{e^{\beta h -\sigma }}{e^{\beta h \sigma}} = e^{ - 2 \beta h \sigma }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.2121079999999997em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5261079999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7751079999999999em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05278em;">β</span><span class="mord mathdefault mtight">h</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05278em;">β</span><span class="mord mathdefault mtight">h</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8991079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span><span class="mord mathdefault mtight" style="margin-right:0.05278em;">β</span><span class="mord mathdefault mtight">h</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span></span></span></span></span></span></span></span></span></span></span></span></span>

<p>With this ratio, the Monte Carlo loop decides whether this proposed move
should be rejected, or accepted. If the move is accepted, the Monte
Carlo calls the <code class="highlighter-rouge">accept</code> method of the move, otherwise it calls the
<code class="highlighter-rouge">reject</code> method. The <code class="highlighter-rouge">accept</code> method should always return 1.0 unless you
want to correct the sign only when moves are accepted for performance
reasons (this rather special case is described in the <code class="highlighter-rouge">full
documentation/manual/triqs &lt;montecarloref&gt;</code>). Note that the return type
of <code class="highlighter-rouge">attempt</code> and <code class="highlighter-rouge">accept</code> has to be the same as the template of the
Monte Carlo class. In our example, nothing has to be done if the move is
rejected. If it is accepted, the spin should be flipped.</p>
    
      <h2 id="the-measure">
        
        
          <a href="#the-measure" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> The measure
        
        
      </h2>

<p>Just in the same way, the measures are expected to satisfy a concept.
Let’s look at <code class="highlighter-rouge">compute_m</code>.</p>

<div class="literalinclude" data-lines="28-45">

overview\_ex.cpp

</div>

<p>Here only two methods are expected, <code class="highlighter-rouge">accumulate</code> and <code class="highlighter-rouge">collect_results</code>.
The method <code class="highlighter-rouge">accumulate</code> is called every <code class="highlighter-rouge">length_cycle</code> Monte Carlo
loops. It takes one argument which is the current sign in the Monte
Carlo simulation. Here, we sum the sign in <code class="highlighter-rouge">Z</code> (the partition function)
and the magnetization in <code class="highlighter-rouge">M</code>. The other method <code class="highlighter-rouge">collect_results</code> is
usually called just once at the very end of the simulation, see below.
It is meant to do the final operations that are needed to have your
result. Here it just needs to divide <code class="highlighter-rouge">M</code> by <code class="highlighter-rouge">Z</code> and prints the result on
the screen. Note that, it takes the MPI communicator as an argument,
meaning that you can easily do MPI operations here. This makes sense
because the accumulation will have taken place independently on all
nodes and this is the good moment to gather the information from all the
nodes. This is why you see reduce operations on the master node here.</p>
    
      <h2 id="starting-the-monte-carlo-simulation">
        
        
          <a href="#starting-the-monte-carlo-simulation" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Starting the Monte Carlo simulation
        
        
      </h2>

<p>Well, at this stage we’re ready to launch our simulation. The moves and
measures have been specified, so all you need to do now is start the
simulation with:</p>

<p><code class="highlighter-rouge">cpp
SpinMC.warmup_and_accumulate(n_warmup_cycles, n_cycles, length_cycle, triqs::utility::clock_callback(600));
</code></p>

<p>The <code class="highlighter-rouge">warmup</code> method takes several arguments.</p>

<p>The first three parameters determine the warmup length, number of
measurements and the length of the Monte Carlo cycles. The definition of
these variables has been detailed earlier in <code class="highlighter-rouge">montecarloloop</code>.</p>

<p>The last argument is used to decide if the simulation must be stopped
for some reason before it reaches the full number of cycles <code class="highlighter-rouge">n_cycles</code>.
For example, you might be running your code on a cluster that only
allows for 1 hour simulations. In that case, you would want your
simulation to stop, say after 55 minutes, even if it didn’t manage to do
the <code class="highlighter-rouge">n_cycles</code> cycles.</p>

<p>In practice, the second argument is a <code class="highlighter-rouge">std::function&lt;bool ()&gt;</code> which is
called at the end of every cycle. If it returns 0 the simulation goes
on, if it returns 1 the simulation stops. In this example, we used a
function <code class="highlighter-rouge">clock_callback(600)</code> which starts returning 1 after 600
seconds. It is defined in the header <code class="highlighter-rouge">&lt;triqs/utility/callbacks.hpp&gt;</code>.
This way the simulation will last at most 10 minutes.</p>

<p>Note that the simulation would end cleanly. The rest of the code can
safely gather results from the statistics that has been accumulated,
even if there have been less than <code class="highlighter-rouge">n_cycles</code> cycles.</p>
    
      <h2 id="end-of-the-simulation---gathering-results">
        
        
          <a href="#end-of-the-simulation---gathering-results" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> End of the simulation - gathering results
        
        
      </h2>

<p>When the simulation is over, it is time to gather the results. This is
done by calling:</p>

<p><code class="highlighter-rouge">cpp
SpinMC.collect_results(world);
</code></p>

<p>In practice this method goes through all the measurements that have been
added to the simulation and calls their <code class="highlighter-rouge">collect_results</code> member. As
described above, this does the final computations needed to get the
result you are interested in. It usually also saves or prints these
results.</p>
    
      <h2 id="writing-your-own-monte-carlo-simulation">
        
        
          <a href="#writing-your-own-monte-carlo-simulation" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Writing your own Monte Carlo simulation
        
        
      </h2>

<p>I hope that this simple example gave you an idea about how to use the
<code class="highlighter-rouge">mc_generic</code> class. In the next chapter we will address some more
advanced issues, but you should already be able to implement a Monte
Carlo simulation of your own. Maybe the only point that we haven’t
addressed and which is useful, is how to generate random numbers.
Actually, as soon as you have generated an instance of a <code class="highlighter-rouge">mc_generic</code>
class, like <code class="highlighter-rouge">SpinMC</code> above, you automatically have an acces to a random
number generator with:</p>

<p><code class="highlighter-rouge">cpp
triqs::mc_tools::random_generator RNG = SpinMC.get_rng();
</code></p>

<p><code class="highlighter-rouge">RNG</code> is an instance of a <code class="highlighter-rouge">random_generator</code>. If you want to generate a
<code class="highlighter-rouge">double</code> number on the interval ([0,1[), you just have to call
<code class="highlighter-rouge">RNG()</code>. By providing an argument to <code class="highlighter-rouge">RNG</code> you can generate integer and
real numbers on different intervals. This is described in detail in the
section <code class="highlighter-rouge">Random number generator &lt;random&gt;</code>.</p>

<p>That’s it! Why don’t you try to write your own Monte Carlo describing
an <code class="highlighter-rouge">Ising chain in a field &lt;isingex&gt;</code>? You will find the solution in
<code class="highlighter-rouge">this section &lt;ising_solution&gt;</code>.</p>
            
          

          
            <hr>
            <footer role="contentinfo">
              <p class="text-small text-grey-dk-000 mb-0">Copyright &copy; 2021 Flatiron Institute. Distributed by an <a href="https://github.com/triqs/triqs/tree/master/LICENSE.txt">GNU GPL license.</a></p>
            </footer>
          

        </div>
      </div>
    </div>
  </div>

</body>
</html>
